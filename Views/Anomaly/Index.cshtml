@{
    ViewData["Title"] = "Anomaly Detection";
}
<br>
<h4>Ladda upp datafil för validering</h4>
<br>

<form asp-controller="Anomaly" asp-action="UploadFile" method="post" enctype="multipart/form-data">
    <div class="form-group">
        <input type="file" name="file" class="form-control" accept=".csv,.json" required />
        <p><em>Följande format stöds: CSV, JSON</em></p>
    </div>
    <button type="submit" class="btn btn-primary">Ladda upp</button>
</form>

@if (ViewData["Message"] != null)
{
    <div class="alert alert-info mt-3">
        @ViewData["Message"]
    </div>
}

@if (ViewData["Uploaded"] != null && (bool)ViewData["Uploaded"] == true)
{
    <form asp-controller="Anomaly" asp-action="Analyze" method="post">
        <button type="submit" class="btn btn-success mt-3">Analysera</button>
    </form>
}

@if (ViewData["AnalysisResult"] != null)
{
    var analysisResult = (Newtonsoft.Json.Linq.JArray)ViewData["AnalysisResult"];

    if (analysisResult.Count == 0)
    {
        <h3 class="text-success mt-3">Inga anomalier upptäckta i filen...</h3>
    }
    else
    {
        var columnMappings = new Dictionary<string, string>
        {
            { "email", "E-post" },
            { "name", "Namn" },
            { "name_email_validity", "E-post giltighet" },
            { "personnummer", "Personnummer" },
            { "personnummer_valid", "Personnummer giltighet" }
        };

        <h3 class="mt-3">Analysresultat:</h3>
        <div class="table-responsive">
            <table class="table table-bordered table-striped mt-3">
                <thead class="thead-dark">
                    <tr>
                        @foreach (var property in analysisResult[0])
                        {
                            var fieldName = property.Path.Split('.').Last();
                            <th>@(columnMappings.ContainsKey(fieldName) ? columnMappings[fieldName] : fieldName)</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var anomaly in analysisResult)
                    {
                        <tr>
                            @foreach (var property in anomaly)
                            {
                                var fieldName = property.Path.Split('.').Last();

                                @if (fieldName == "name_email_validity")
                                {
                                <td class="text-center @(property.First.ToString() == "1" ? "text-success" : "text-danger")">
                                    <strong>@(property.First.ToString() == "1" ? "Godkänt" : "Avvikelse")</strong>
                                </td>
                                }
                                else if (fieldName == "personnummer_valid")
                                {
                                    var personnummerValidity = property.First?.ToString() ?? string.Empty;

                                    if (!string.IsNullOrEmpty(personnummerValidity) && personnummerValidity.Contains("Avvikelse"))
                                    {
                                        <td class="text-center text-danger">
                                            <strong>@personnummerValidity</strong> 
                                        </td>
                                    }
                                    else if (!string.IsNullOrEmpty(personnummerValidity))
                                    {
                                        <td class="text-center text-success">
                                            <strong>Godkänt</strong>
                                        </td>
                                    }
                                    else
                                    {
                                        <td class="text-center text-danger">
                                            <strong>Felaktigt</strong>
                                        </td>
                                    }
                                }
                                else if (fieldName != "AnomalyReason")
                                {
                                    <td>@property.First</td>
                                }
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}
